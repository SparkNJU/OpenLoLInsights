# OpenLoLInsights 需求规格说明书

## 1. 引言

### 1.1 项目背景
电子竞技（特别是英雄联盟）数据量庞大且维度复杂，涵盖赛事历史、实时对局、选手表现、版本变动等。目前市场上缺乏一款能够同时满足“深度专业分析”与“大众快速查询”的智能化数据工具。OpenLoLInsights 旨在通过大语言模型（LLM）与结构化数据库的结合，填补这一空白。

### 1.2 目标受众与场景
本系统针对两类差异化明显的用户群体，提供两种特定的交互模式：

| 用户群体 | 典型角色 | 核心痛点 | 对应系统模式 |
| :--- | :--- | :--- | :--- |
| **内容创作者与专业人士** | 自媒体博主、电竞媒体编辑、赛事官方运营、战队分析师、解说/主持 | 需要撰写长篇赛评、复盘报告、前瞻预测；数据搜集耗时，难以将数据与观点深度结合。 | **Report 模式 (深度分析)** |
| **社区用户与普通观众** | 贴吧/论坛用户、直播观众、普通玩家 | 想要快速验证某个观点（如“Faker这个英雄胜率多少”），需要即时、准确的简短答案。 | **Simple Mode (快速问答)** |

---

## 2. 功能需求

### 2.1 智能体交互模式 (Agent Interaction Modes)

#### 2.1.1 Simple Mode (快速问答模式)
*   **输入**：自然语言短句（例如：“2024年S赛T1对阵BLG的胜率是多少？”）。
*   **处理机制**：
    *   优先触发 NL2SQL (Natural Language to SQL) 引擎，从本地数据库精确查询结构化数据。
    *   若数据库无查询结果或查询失败，自动降级为 Web Search（联网搜索）获取公开信息。
*   **输出要求**：
    *   **响应速度**：高（秒级响应）。
    *   **格式**：简短文本（3-8句），直接给出结论，辅以关键数据支撑。
    *   **准确性**：对于客观数据问题，必须保证 100% 准确（基于 DB）。

#### 2.1.2 Report Mode (深度报告模式)
*   **输入**：分析主题或复杂指令（例如：“生成一份2025 LPL春季赛 BLG 战队目前的表现分析报告，包含经济曲线和关键选手数据”）。
*   **处理机制**：
    *   **混合检索 (Hybrid Retrieval)**：同时执行高强度的 SQL 统计查询（获取 KDA、胜率、分均伤害等硬数据）和 Web 搜索（获取版本理解、近期舆论、转会评价等软信息）。
    *   **长文生成**：LLM 结合上述多源信息，生成结构化文章。
    *   **文件生成**：支持将报告生成为 Markdown 文件供用户下载。
*   **输出要求**：
    *   **内容深度**：需包含摘要、详细数据分析、趋势判断、改进建议等章节。
    *   **格式**：结构化 Markdown，包含多级标题、数据列表。
    *   **受众适配**：语言风格专业、详实，适合直接用于视频脚本或文章素材。

### 2.2 数据查询与检索能力
*   **多维度统计**：支持按赛季、赛事阶段（常规赛/季后赛）、战队、选手、红蓝方等多维度进行交叉查询。
*   **容错与兜底**：当本地数据库架构不支持用户问题（例如“亚索的背景故事”）或数据库服务异常时，系统应无缝切换至网络搜索，不中断用户体验。

### 2.3 Web 前端交互
*   支持流式输出 (Stream)：打字机效果展示 AI 思考过程和生成内容。
*   支持 Markdown 渲染：正确显示表格、列表、加粗等格式。
*   历史记录管理：用户可查看过往的对话记录。

---

## 3. 用户故事 (User Stories)

| 角色 | 能够... (I want to...) | 以便... (So that...) | 验收标准 (Acceptance Criteria) |
| :--- | :--- | :--- | :--- |
| **电竞自媒体** | 输入“生成2025 LPL春季赛第一周数据报告” | 快速获取文章素材，减少查阅数据库的时间 | 1. 报告需包含战队胜率、KDA前五选手。<br>2. 报告字数 > 800字。<br>3. 包含可下载的 Markdown 文件。 |
| **普通观众** | 询问“昨天 T1 比赛谁赢了？” | 在不打开直播回放的情况下快速获知结果 | 1. 回答准确无误。<br>2. 回复时间 < 3秒。<br>3. 仅展示比分和关键先生，不过多冗余。 |
| **数据分析师** | 询问“Faker在S赛使用沙皇的所有场次胜率” | 验证特定的战术猜想 | 1. 系统触发 SQL 查询而非网页搜索。<br>2. 即使数据库字段复杂，也能通过 NL2SQL 正确聚合数据。 |
| **系统管理员** | 在后台查看 Agent 工具调用日志 | 监控系统是否准确调用了数据库或搜索工具 | 1. 日志清晰展示 "Search" -> "NL2SQL" -> "DB" 的步骤。<br>2. 能看到每一步的耗时。 |

## 4. 用例 (Use Cases)

### UC01: 快速赛事查询 (Simple Mode)
*   **前置条件**: 用户已登录系统，服务运行正常。
*   **主流程**:
    1.  用户在聊天框输入简短问题（如“BLG下场比赛打谁？”）。
    2.  前端发送 API 请求，标记 mode="simple"。
    3.  Agent 识别意图，进行网页搜索（serper_tool）。
    4.  Agent 综合最新赛程信息，生成并将简短回答流式推送到前端。
    5.  前端显示回答结束。
*   **异常流程**:
    *   搜索 API 超时 -> 系统返回“网络拥堵，请稍后重试”或展示缓存数据。

### UC02: 深度数据挖掘报告 (Report Mode)
*   **前置条件**: 用户选择“深度报告模式”。
*   **主流程**:
    1.  用户输入复杂指令（如“分析当前版本蓝色方胜率优势原因”）。
    2.  Agent 并行启动多轮搜索（Web）和数据库聚合查询（SQL）。
        *   SQL 查询红蓝方历史胜率数据。
        *   Web 搜索当前版本补丁解读和职业选手采访。
    3.  Agent 将收集到的异构数据（结构化数字 + 非结构化文本）整合。
    4.  Agent 按照“摘要-数据-分析-结论”的模板生成 Markdown。
    5.  后端将生成的文件 ID 返回给前端。
    6.  前端展示报告预览，并提供下载按钮。

---

## 5. 非功能需求

### 3.1 性能要求
*   **Simple Mode**：首字生成延迟 (TTFT) < 2秒。
*   **Report Mode**：完整报告生成时间在可接受范围内（例如 30-60秒），需通过进度条或流式输出安抚用户等待。

### 3.2 可靠性
*   **数据一致性**：AI 输出的统计数据必须与数据库记录一致，杜绝“幻觉”导致的数值错误。
*   **服务降级**：当依赖组件（如 MySQL 或 Search API）不可用时，系统应提供友好的降级服务（如仅聊天或提示服务受限），而非直接崩溃。

### 3.3 扩展性
*   Agent 架构需支持未来添加新的工具（如 Python 代码解释器用于绘制图表、RAG 向量库用于查询游戏攻略）。

## 4. 数据需求
*   **核心赛事数据**：涵盖 LPL、LCK、MSI、S赛等主流赛事的 战队、选手、比赛(Matches)、小局(Games)、选手表现(PlayerStats)。
*   **更新频率**：需具备定期从外部数据源（如 OracleElixir, 官方 API）同步数据的能力。
